SELECT
SUBSTR(CODSECAO,1,7)AS CODSECAO,
CIDADE,
CHAPA,
NOME,
ROUND(Sum(ACUMULADO_FER),2)AS ACUMULADO_FER,
NVL(INSS_FER_1,0)  AS INSS_FER ,
NVL(FGTS_FER,0) AS FGTS_FER,
NVL(CERES_FER,0) AS CERES_FER,
ROUND(Sum(ACUMULADO_13- ACUMULADO_13_RESC),2) AS ACUMULADO_13,
(CASE     
	WHEN CODOCORRENCIA<>4 AND SUBSTR(CODSECAO,1,7)='1.01.01'THEN ROUND(NVL(Sum(INSS_13),0)*0.268000,2)
    WHEN CODOCORRENCIA=4 AND SUBSTR(CODSECAO,1,7)='1.01.01'THEN ROUND(NVL(Sum(INSS_13),0)*0.328000,2)
    WHEN CODOCORRENCIA<>4 AND SUBSTR(CODSECAO,1,7)='1.02.01'THEN ROUND(NVL(Sum(INSS_13),0)*0.268000,2)
    WHEN CODOCORRENCIA=4 AND SUBSTR(CODSECAO,1,7)='1.02.01'THEN ROUND(NVL(Sum(INSS_13),0)*0.328000,2)
    WHEN CODOCORRENCIA<>4 AND SUBSTR(CODSECAO,1,7)='1.02.02'THEN ROUND(NVL(Sum(INSS_13),0)*0.268000,2)
    WHEN CODOCORRENCIA=4 AND SUBSTR(CODSECAO,1,7)='1.02.02'THEN ROUND(NVL(Sum(INSS_13),0)*0.328000,2)
    WHEN CODOCORRENCIA<>4 AND SUBSTR(CODSECAO,1,7)='1.02.03'THEN ROUND(NVL(Sum(INSS_13),0)*0.268000,2)
    WHEN CODOCORRENCIA=4 AND SUBSTR(CODSECAO,1,7)='1.02.03'THEN ROUND(NVL(Sum(INSS_13),0)*0.328000,2)
    WHEN CODOCORRENCIA<>4 AND SUBSTR(CODSECAO,1,7)='1.03.01'THEN ROUND(NVL(Sum(INSS_13),0)*0.268000,2)
    WHEN CODOCORRENCIA=4 AND SUBSTR(CODSECAO,1,7)='1.03.01'THEN ROUND(NVL(Sum(INSS_13),0)*0.328000,2)
    WHEN CODOCORRENCIA<>4 AND SUBSTR(CODSECAO,1,7)='1.04.01'THEN ROUND(NVL(Sum(INSS_13),0)*0.268000,2)
    WHEN CODOCORRENCIA=4 AND SUBSTR(CODSECAO,1,7)='1.04.01'THEN ROUND(NVL(Sum(INSS_13),0)*0.328000,2)
    WHEN CODOCORRENCIA<>4 AND SUBSTR(CODSECAO,1,7)='1.04.03'THEN ROUND(NVL(Sum(INSS_13),0)*0.268000,2)
    WHEN CODOCORRENCIA=4 AND SUBSTR(CODSECAO,1,7)='1.04.03'THEN ROUND(NVL(Sum(INSS_13),0)*0.328000,2)
    WHEN CODOCORRENCIA<>4 AND SUBSTR(CODSECAO,1,7)='1.04.04'THEN ROUND(NVL(Sum(INSS_13),0)*0.268000,2)
    WHEN CODOCORRENCIA=4 AND SUBSTR(CODSECAO,1,7)='1.04.04'THEN ROUND(NVL(Sum(INSS_13),0)*0.328000,2)
    WHEN CODOCORRENCIA<>4 AND SUBSTR(CODSECAO,1,7)='1.05.01'THEN ROUND(NVL(Sum(INSS_13),0)*0.268000,2)
    WHEN CODOCORRENCIA=4 AND SUBSTR(CODSECAO,1,7)='1.05.01'THEN ROUND(NVL(Sum(INSS_13),0)*0.328000,2)
    WHEN CODOCORRENCIA<>4 AND SUBSTR(CODSECAO,1,7)='1.05.02'THEN ROUND(NVL(Sum(INSS_13),0)*0.268000,2)
    WHEN CODOCORRENCIA=4 AND SUBSTR(CODSECAO,1,7)='1.05.02'THEN ROUND(NVL(Sum(INSS_13),0)*0.328000,2)
    WHEN CODOCORRENCIA<>4 AND SUBSTR(CODSECAO,1,7)='1.05.03'THEN ROUND(NVL(Sum(INSS_13),0)*0.268000,2)
    WHEN CODOCORRENCIA=4 AND SUBSTR(CODSECAO,1,7)='1.05.03'THEN ROUND(NVL(Sum(INSS_13),0)*0.328000,2)
    WHEN CODOCORRENCIA<>4 AND SUBSTR(CODSECAO,1,7)='1.05.04'THEN ROUND(NVL(Sum(INSS_13),0)*0.296272,2)
    WHEN CODOCORRENCIA=4 AND SUBSTR(CODSECAO,1,7)='1.05.04'THEN ROUND(NVL(Sum(INSS_13),0)*0.356272,2)
    WHEN CODOCORRENCIA<>4 AND SUBSTR(CODSECAO,1,7)='1.05.05'THEN ROUND(NVL(Sum(INSS_13),0)*0.268000,2)
    WHEN CODOCORRENCIA=4 AND SUBSTR(CODSECAO,1,7)='1.05.05'THEN ROUND(NVL(Sum(INSS_13),0)*0.328000,2)
    WHEN CODOCORRENCIA<>4 AND SUBSTR(CODSECAO,1,7)='1.06.01'THEN ROUND(NVL(Sum(INSS_13),0)*0.268000,2)
    WHEN CODOCORRENCIA=4 AND SUBSTR(CODSECAO,1,7)='1.06.01'THEN ROUND(NVL(Sum(INSS_13),0)*0.328000,2)
    WHEN CODOCORRENCIA<>4 AND SUBSTR(CODSECAO,1,7)='1.06.02'THEN ROUND(NVL(Sum(INSS_13),0)*0.268000,2)
    WHEN CODOCORRENCIA=4 AND SUBSTR(CODSECAO,1,7)='1.06.02'THEN ROUND(NVL(Sum(INSS_13),0)*0.328000,2)
    WHEN CODOCORRENCIA<>4 AND SUBSTR(CODSECAO,1,7)='1.06.03'THEN ROUND(NVL(Sum(INSS_13),0)*0.268000,2)
    WHEN CODOCORRENCIA=4 AND SUBSTR(CODSECAO,1,7)='1.06.03'THEN ROUND(NVL(Sum(INSS_13),0)*0.328000,2)
    WHEN CODOCORRENCIA<>4 AND SUBSTR(CODSECAO,1,7)='1.06.04'THEN ROUND(NVL(Sum(INSS_13),0)*0.278000,2)
    WHEN CODOCORRENCIA=4 AND SUBSTR(CODSECAO,1,7)='1.06.04'THEN ROUND(NVL(Sum(INSS_13),0)*0.338000,2)
    WHEN CODOCORRENCIA<>4 AND SUBSTR(CODSECAO,1,7)='1.06.05'THEN ROUND(NVL(Sum(INSS_13),0)*0.268000,2)
    WHEN CODOCORRENCIA=4 AND SUBSTR(CODSECAO,1,7)='1.06.05'THEN ROUND(NVL(Sum(INSS_13),0)*0.328000,2)
    WHEN CODOCORRENCIA<>4 AND SUBSTR(CODSECAO,1,7)='1.06.06'THEN ROUND(NVL(Sum(INSS_13),0)*0.278000,2)
    WHEN CODOCORRENCIA=4 AND SUBSTR(CODSECAO,1,7)='1.06.06'THEN ROUND(NVL(Sum(INSS_13),0)*0.338000,2)
    WHEN CODOCORRENCIA<>4 AND SUBSTR(CODSECAO,1,7)='1.06.07'THEN ROUND(NVL(Sum(INSS_13),0)*0.268000,2)
    WHEN CODOCORRENCIA=4 AND SUBSTR(CODSECAO,1,7)='1.06.07'THEN ROUND(NVL(Sum(INSS_13),0)*0.328000,2)
    WHEN CODOCORRENCIA<>4 AND SUBSTR(CODSECAO,1,7)='1.06.08'THEN ROUND(NVL(Sum(INSS_13),0)*0.268000,2)
    WHEN CODOCORRENCIA=4 AND SUBSTR(CODSECAO,1,7)='1.06.08'THEN ROUND(NVL(Sum(INSS_13),0)*0.328000,2)
    WHEN CODOCORRENCIA<>4 AND SUBSTR(CODSECAO,1,7)='1.06.10'THEN ROUND(NVL(Sum(INSS_13),0)*0.268000,2)
    WHEN CODOCORRENCIA=4 AND SUBSTR(CODSECAO,1,7)='1.06.10'THEN ROUND(NVL(Sum(INSS_13),0)*0.328000,2)
    WHEN CODOCORRENCIA<>4 AND SUBSTR(CODSECAO,1,7)='1.06.11'THEN ROUND(NVL(Sum(INSS_13),0)*0.268000,2)
    WHEN CODOCORRENCIA=4 AND SUBSTR(CODSECAO,1,7)='1.06.11'THEN ROUND(NVL(Sum(INSS_13),0)*0.328000,2)
    WHEN CODOCORRENCIA<>4 AND SUBSTR(CODSECAO,1,7)='1.07.01'THEN ROUND(NVL(Sum(INSS_13),0)*0.268000,2)
    WHEN CODOCORRENCIA=4 AND SUBSTR(CODSECAO,1,7)='1.07.01'THEN ROUND(NVL(Sum(INSS_13),0)*0.328000,2)
    WHEN CODOCORRENCIA<>4 AND SUBSTR(CODSECAO,1,7)='1.07.02'THEN ROUND(NVL(Sum(INSS_13),0)*0.278000,2)
    WHEN CODOCORRENCIA=4 AND SUBSTR(CODSECAO,1,7)='1.07.02'THEN ROUND(NVL(Sum(INSS_13),0)*0.338000,2)
    WHEN CODOCORRENCIA<>4 AND SUBSTR(CODSECAO,1,7)='1.07.03'THEN ROUND(NVL(Sum(INSS_13),0)*0.268000,2)
    WHEN CODOCORRENCIA=4 AND SUBSTR(CODSECAO,1,7)='1.07.03'THEN ROUND(NVL(Sum(INSS_13),0)*0.328000,2)
    WHEN CODOCORRENCIA<>4 AND SUBSTR(CODSECAO,1,7)='1.07.05'THEN ROUND(NVL(Sum(INSS_13),0)*0.278000,2)
    WHEN CODOCORRENCIA=4 AND SUBSTR(CODSECAO,1,7)='1.07.05'THEN ROUND(NVL(Sum(INSS_13),0)*0.338000,2)
    WHEN CODOCORRENCIA<>4 AND SUBSTR(CODSECAO,1,7)='1.08.01'THEN ROUND(NVL(Sum(INSS_13),0)*0.268000,2)
    WHEN CODOCORRENCIA=4 AND SUBSTR(CODSECAO,1,7)='1.08.01'THEN ROUND(NVL(Sum(INSS_13),0)*0.328000,2)
    WHEN CODOCORRENCIA<>4 AND SUBSTR(CODSECAO,1,7)='1.08.02'THEN ROUND(NVL(Sum(INSS_13),0)*0.268000,2)
    WHEN CODOCORRENCIA=4 AND SUBSTR(CODSECAO,1,7)='1.08.02'THEN ROUND(NVL(Sum(INSS_13),0)*0.328000,2)
    WHEN CODOCORRENCIA<>4 AND SUBSTR(CODSECAO,1,7)='1.08.03'THEN ROUND(NVL(Sum(INSS_13),0)*0.268000,2)
    WHEN CODOCORRENCIA=4 AND SUBSTR(CODSECAO,1,7)='1.08.03'THEN ROUND(NVL(Sum(INSS_13),0)*0.328000,2)
      
ELSE 0 END) AS INSS_13,

CASE 
WHEN NVL(Sum(FGTS_13),0)>0  AND CODTIPO='Z'  AND CODSITUACAO <>'D'  THEN ROUND((NVL(Sum(FGTS_13_1),0) - (NVL(Sum(FGTS_13_ADIAN),0)))* 0.02,2)
WHEN NVL(Sum(FGTS_13),0)>0  AND CODTIPO='Z'  AND CODSITUACAO ='D'   THEN ROUND((NVL(Sum(FGTS_13),0) - (NVL(Sum(FGTS_13_ADIAN),0)))* 0.02,2)
WHEN NVL(Sum(FGTS_13),0)>0  AND CODTIPO<>'Z' AND CODSITUACAO ='D'   THEN ROUND((NVL(Sum(FGTS_13+FGTS_13_1),0)- NVL(Sum(FGTS_13_ADIAN),0))*0.08,2) 
WHEN NVL(Sum(FGTS_13),0)>0  AND CODTIPO<>'Z' AND CODSITUACAO <>'D' AND CODTIPO<>'5' THEN  ROUND((NVL(Sum(FGTS_13),0)- NVL(Sum(FGTS_13_1+FGTS_13_2),0))*0.08/2,2) 
WHEN  CODTIPO='Z' AND NVL(Sum(FGTS_13),0)<=0  THEN  ROUND((NVL(Sum(FGTS_13_1+FGTS_13_2),0) - (NVL(Sum(FGTS_13_ADIAN),0)))* 0.02,2)
ELSE ROUND((NVL(Sum(FGTS_13_1+FGTS_13_2),0) - (NVL(Sum(FGTS_13_ADIAN),0)))* 0.08,2) END AS FGTS_13,

CASE 
WHEN ROUND((((Sum(FGTS_13)- Sum(FGTS_13_1))+Sum(FGTS_13_2x))*CERESFLEX05)/100,2)<=0 THEN 0 
WHEN ROUND((((Sum(FGTS_13)- Sum(FGTS_13_1))+Sum(FGTS_13_2x))*CERESFLEX05)/100,2)>0 AND NROAVOS13DEC<12
AND CHAPA NOT IN ('010880' ,'009597','006957','011889','009581') /*retirar apÃ³s novembro2018 */
THEN Sum(CERES_EVENTO)
WHEN ROUND((((Sum(FGTS_13)- Sum(FGTS_13_1))+Sum(FGTS_13_2x)-sum(VALOR_MEDIA13/12*NROAVOS13DEC))*1),2) >'12481.23' /* VERIFICAR TETO CERES */
THEN ROUND(('12481,23'* CERESFLEX05)/100,2)
ELSE ROUND((((Sum(FGTS_13)- Sum(FGTS_13_1))+Sum(FGTS_13_2x)-sum(VALOR_MEDIA13))*CERESFLEX05)/100,2) END AS CERES_13,
CODSECAO ,

SYSDATE

FROM
(SELECT CODSECAO,CIDADE,
CHAPA,NOME,
AVOS,
NROAVOS13DEC,
(CASE WHEN CODEVENTO IN (0046,0047,0048,0106,0109) THEN VALOR ELSE 0 END)AS ACUMULADO_FER ,
INSS_FER_1 ,
(CASE WHEN CODEVENTO IN (0046,0047,0048,0106,0109) THEN VALOR ELSE 0 END)AS INSS_FER_2,
FGTS_FER,
(CASE WHEN CODEVENTO IN (0042,0041) THEN VALOR ELSE 0 END)AS ACUMULADO_13,
(CASE WHEN CODEVENTO IN (1036,1552) THEN VALOR ELSE 0 END)AS ACUMULADO_13_RESC,
(CASE WHEN CODEVENTO IN (0042,0041) THEN VALOR ELSE 0 END)AS INSS_13 ,   /* eventos considerados*/
(CASE WHEN CODEVENTO IN (1036,1552) THEN VALOR ELSE 0 END)AS INSS_13_RESC, 
 (CASE WHEN CODEVENTO IN (0042,3028) THEN VALOR ELSE 0 END)AS FGTS_13 , /* EVENTO 3028 ADICIONADO - 10/06/2022 A PEDIDO DA MARLICE VIA CHAMADO 121908 */
/* (CASE WHEN CODEVENTO IN (0042) THEN VALOR ELSE 0 END)AS FGTS_13 , */
(CASE WHEN CODEVENTO IN (0040) THEN VALOR ELSE 0 END)AS FGTS_13_1 ,
(CASE WHEN CODEVENTO IN (0041) THEN VALOR ELSE 0 END)AS FGTS_13_2 ,
(CASE WHEN CODEVENTO IN (0041) AND VALOR>=12481.23 THEN 12481.23 
      WHEN CODEVENTO IN (0041) AND VALOR<12481.23 THEN VALOR
      ELSE 0 END)AS FGTS_13_2x,

(CASE WHEN CODEVENTO IN (1024) THEN VALOR ELSE 0 END)AS FGTS_13_ADIAN,
(CASE WHEN CODEVENTO IN (3091) THEN VALOR ELSE 0 END)AS VALOR_MEDIA13,
CERES_FER,
(CASE WHEN CODEVENTO IN (1901) THEN VALOR ELSE 0 END)AS CERES_EVENTO,



CERESFLEX05,CODTIPO,DATADEMISSAO ,CODSITUACAO,CODOCORRENCIA

FROM

(SELECT
PFUNC.CODSECAO,
PFUNC.CHAPA,
PFUNC.NOME,
PFFINANC.VALOR ,
PFFINANC.CODEVENTO ,
(PFHSTPROV.NROAVOSVENCFERDEC + PFHSTPROV.NROAVOSPROPORCDEC) AVOS ,
PFHSTPROV.NROAVOS13DEC,
PFUNC.CODOCORRENCIA,
CERESFLEX05,
PFUNC.CODTIPO,
TO_CHAR(PFUNC.DATADEMISSAO,'DD/MM/YYYY') AS DATADEMISSAO,
PFUNC.CODSITUACAO,
PSECAO.CIDADE,
(SELECT SUM(PF.VALOR) FROM PFENCARGO PF WHERE PF.CODENCARGO='124' AND PF.MESCOMP=:MES AND PF.ANOCOMP=:ANO AND PF.CHAPA=PFUNC.CHAPA) AS INSS_FER_1, 
(SELECT SUM(PF.VALOR) FROM PFENCARGO PF WHERE PF.CODENCARGO='125' AND PF.MESCOMP=:MES AND PF.ANOCOMP=:ANO AND PF.CHAPA=PFUNC.CHAPA) AS FGTS_FER,
(SELECT SUM(PF.VALOR) FROM PFENCARGO PF WHERE PF.CODENCARGO='126' AND PF.MESCOMP=:MES AND PF.ANOCOMP=:ANO AND PF.CHAPA=PFUNC.CHAPA) AS CERES_FER


FROM PFUNC
LEFT JOIN PFFINANC ON (PFUNC.CHAPA=PFFINANC.CHAPA)
LEFT JOIN PFHSTPROV ON (PFUNC.CHAPA=PFHSTPROV.CHAPA)
LEFT JOIN PFCOMPL ON (PFCOMPL.CHAPA=PFUNC.CHAPA)
LEFT JOIN PSECAO ON (PSECAO.CODIGO=PFUNC.CODSECAO)

WHERE  PFFINANC.MESCOMP=:MES
AND PFFINANC.ANOCOMP=:ANO
AND SUBSTR(PFUNC.CODSECAO,1,7)  LIKE :CODSECAO
AND PFHSTPROV.ANO=:ANO
AND PFHSTPROV.MES=:MES
AND PFUNC.CHAPA LIKE :CHAPA
AND PFUNC.CODCOLIGADA =1
AND PFUNC.CODSITUACAO LIKE :CODSITUACAO
AND PFFINANC.CODEVENTO IN (0040,0041,0042,0046,0047,0048,0106,0108,0109,1024,3091,3028,1901,1036,1552) /* EVENTO 3028 ADICIONADO - 10/06/2022 A PEDIDO DA MARLICE VIA CHAMADO 121908 */
))

GROUP BY
CODSECAO,
CHAPA,NOME,
AVOS,
NROAVOS13DEC,
CERESFLEX05,
CODTIPO,
DATADEMISSAO ,
CODSITUACAO,
CIDADE,
INSS_FER_1,
FGTS_FER,
CERES_FER,
CODOCORRENCIA
ORDER BY NOME
